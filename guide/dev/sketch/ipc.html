<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IPC - Tere Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../doc/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../architecture/index.html"><strong aria-hidden="true">2.</strong> Architecture</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../architecture/dbus.html"><strong aria-hidden="true">2.1.</strong> D-Bus</a></li></ol></li><li class="chapter-item expanded "><a href="../../roadmap.html"><strong aria-hidden="true">3.</strong> Roadmap</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Comparisons</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../compare/openssh.html"><strong aria-hidden="true">4.1.</strong> OpenSSH</a></li><li class="chapter-item "><a href="../../compare/mosh.html"><strong aria-hidden="true">4.2.</strong> Mosh</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> For developers</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/decisions.html"><strong aria-hidden="true">5.1.</strong> Decisions</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.2.</strong> Background</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/background/dbus.html"><strong aria-hidden="true">5.2.1.</strong> D-Bus</a></li><li class="chapter-item "><a href="../../dev/background/websockets.html"><strong aria-hidden="true">5.2.2.</strong> WebSockets</a></li><li class="chapter-item "><a href="../../dev/background/pty-stdin-stdout.html"><strong aria-hidden="true">5.2.3.</strong> PTY to stdin/stdout plumbing</a></li></ol></li><li class="chapter-item expanded "><a href="../../dev/sketch/index.html"><strong aria-hidden="true">5.3.</strong> Sketches</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/sketch/privsep.html"><strong aria-hidden="true">5.3.1.</strong> Privilege separation</a></li><li class="chapter-item "><a href="../../dev/sketch/protocols.html"><strong aria-hidden="true">5.3.2.</strong> Protocols used in IPC</a></li><li class="chapter-item expanded "><a href="../../dev/sketch/ipc.html" class="active"><strong aria-hidden="true">5.3.3.</strong> IPC</a></li><li class="chapter-item "><a href="../../dev/sketch/attacks.html"><strong aria-hidden="true">5.3.4.</strong> Attacks</a></li><li class="chapter-item "><a href="../../dev/sketch/bastion.html"><strong aria-hidden="true">5.3.5.</strong> Bastion hosts considered harmful</a></li><li class="chapter-item "><a href="../../dev/sketch/unattended-authentication.html"><strong aria-hidden="true">5.3.6.</strong> Unattended authentication</a></li><li class="chapter-item "><a href="../../dev/sketch/account-store.html"><strong aria-hidden="true">5.3.7.</strong> Account store</a></li></ol></li><li class="chapter-item "><a href="../../dev/TODO.html"><strong aria-hidden="true">5.4.</strong> Tasks</a></li><li class="chapter-item "><a href="../../dev/resources.html"><strong aria-hidden="true">5.5.</strong> Resources</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Tere Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="inter-process-communication-ipc"><a class="header" href="#inter-process-communication-ipc">Inter-Process Communication (IPC)</a></h1>
<p>If we do <a href="privsep.html">privilege separation</a>, we're going to have multiple processes that need to interact.
If we're parsing websocket messages in one process, but keeping the PTY fds safe in another, that means we're doing some form of IPC for every chunk of input &amp; output the user experiences; likely more than once.
We need an IPC mechanism that won't become the bottleneck.
We also want to have one that can pass file descriptors, which eliminates most common RPC mechanisms, that are aimed at networking.
Let's explore our options.</p>
<h2 id="open-question-broadcasting-shell-session-content"><a class="header" href="#open-question-broadcasting-shell-session-content">Open question: Broadcasting shell session content</a></h2>
<h3 id="ringbuffers-in-shared-memory"><a class="header" href="#ringbuffers-in-shared-memory">Ringbuffers in shared memory</a></h3>
<p>If the mechanism natively supports multiple consumers seeing the same data, how do we kick out slow consumers?</p>
<h3 id="just-send-data-on-unix-domain-socket"><a class="header" href="#just-send-data-on-unix-domain-socket">Just send data on UNIX domain socket</a></h3>
<p>Now we need a broadcast pub/sub mechanism, either on the sender side or receiver.</p>
<h2 id="design-sketch-circuits"><a class="header" href="#design-sketch-circuits">Design sketch: Circuits</a></h2>
<p><code>circuits</code> is a (TODO to-be-written) module/crate providing a simple mechanism for transporting multiple logical circuits over one (framed, message-based) stream.
If a transport is not natively framed, length-prefixed messages are an easy solution for framing messages.</p>
<p>Circuits are comparable to remote procedure calls where each request contains a request ID and responses to refer to those, except each circuit can operate its own multi-stage protocol and can stream data.</p>
<p>Since tungstenite, the websocket library used here, assumes that messages fit in memory, and on the other end bincode/other serde mechanisms often make the same assumption, the circuits API will likely assume that too; but this is not an inherent limitation of the design.</p>
<p>Each transport carries <code>max_circuits</code> circuits, defined by the protocol logic being generic over a suitable integer type.
All circuits are &quot;virtually open&quot; at all times, there are no open/close messages.
Circuits are &quot;idle&quot; if they are available for use, or &quot;busy&quot; if they are currently in use.</p>
<p>For a communicating pair of endpoints, previously agreed upon circuit IDs may be reserved and used for special purposes.
All other circuits are interchangeable when idle.</p>
<p>Circuits <em>must</em> support messages bearing ancillary data, such as UNIX domain socket file descriptor passing, when the transport is capable of such.</p>
<p>Backpressure may or may not be implemented, to be discovered later.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../dev/sketch/protocols.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../dev/sketch/attacks.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../dev/sketch/protocols.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../dev/sketch/attacks.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../doc/mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../doc/mermaid-init.js"></script>
        

        

    </body>
</html>
