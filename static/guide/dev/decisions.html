<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Decisions - Tere Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../doc/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">2.</strong> Architecture</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../architecture/dbus.html"><strong aria-hidden="true">2.1.</strong> D-Bus</a></li></ol></li><li class="chapter-item expanded "><a href="../roadmap.html"><strong aria-hidden="true">3.</strong> Roadmap</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Comparisons</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../compare/openssh.html"><strong aria-hidden="true">4.1.</strong> OpenSSH</a></li><li class="chapter-item "><a href="../compare/mosh.html"><strong aria-hidden="true">4.2.</strong> Mosh</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> For developers</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/decisions.html" class="active"><strong aria-hidden="true">5.1.</strong> Decisions</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.2.</strong> Background</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/background/dbus.html"><strong aria-hidden="true">5.2.1.</strong> D-Bus</a></li><li class="chapter-item "><a href="../dev/background/websockets.html"><strong aria-hidden="true">5.2.2.</strong> WebSockets</a></li><li class="chapter-item "><a href="../dev/background/pty-stdin-stdout.html"><strong aria-hidden="true">5.2.3.</strong> PTY to stdin/stdout plumbing</a></li></ol></li><li class="chapter-item "><a href="../dev/sketch/index.html"><strong aria-hidden="true">5.3.</strong> Sketches</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/sketch/privsep.html"><strong aria-hidden="true">5.3.1.</strong> Privilege separation</a></li><li class="chapter-item "><a href="../dev/sketch/protocols.html"><strong aria-hidden="true">5.3.2.</strong> Protocols used in IPC</a></li><li class="chapter-item "><a href="../dev/sketch/ipc.html"><strong aria-hidden="true">5.3.3.</strong> IPC</a></li><li class="chapter-item "><a href="../dev/sketch/attacks.html"><strong aria-hidden="true">5.3.4.</strong> Attacks</a></li><li class="chapter-item "><a href="../dev/sketch/bastion.html"><strong aria-hidden="true">5.3.5.</strong> Bastion hosts considered harmful</a></li><li class="chapter-item "><a href="../dev/sketch/unattended-authentication.html"><strong aria-hidden="true">5.3.6.</strong> Unattended authentication</a></li><li class="chapter-item "><a href="../dev/sketch/account-store.html"><strong aria-hidden="true">5.3.7.</strong> Account store</a></li></ol></li><li class="chapter-item "><a href="../dev/TODO.html"><strong aria-hidden="true">5.4.</strong> Tasks</a></li><li class="chapter-item "><a href="../dev/resources.html"><strong aria-hidden="true">5.5.</strong> Resources</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Tere Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="decisions"><a class="header" href="#decisions">Decisions</a></h1>
<p>These are things that have already been thought about, to various levels.
Some go into more detail, as necessary.</p>
<h2 id="pretty-firm"><a class="header" href="#pretty-firm">Pretty firm</a></h2>
<h3 id="rust"><a class="header" href="#rust">Rust</a></h3>
<p>Tere is programmed in Rust.
It gives a nice sense of safety, but even more importantly it allows low-level control over threads, processes &amp; syscalls that makes Seccomp and Landlock style fine-grained sandboxing feasible.</p>
<h3 id="systemd"><a class="header" href="#systemd">systemd</a></h3>
<p>Why use systemd?
Because it gets us features, and it's going to be installed anyway.</p>
<ul>
<li>Tere doesn't even need to run as root!</li>
<li>systemd will let us create sessions, on host or in container, with a simple call, not worry about dropping privileges and what not</li>
<li>systemd will sandbox our whole service</li>
<li>systemd will terminate sessions reliably, with cgroups, including if we crash before persisting a pty fd</li>
<li>we can store pty fds in systemd and have sessions survive restarts</li>
</ul>
<p>Not so nice trade-offs include</p>
<ul>
<li>need to use in-filesystem UNIX domain sockets to connect privsep components, instead of <code>socketpair</code> and <code>fork</code></li>
<li>runtime reliability depends on a whole lot of components (then again, most Linux distros these days depend on them anyway)</li>
</ul>
<p>What about other platforms and niche Linux distributions?
We can work on compatibility later, need to get things working first.
Nothing in the big picture depends on systemd, it's just conveniences, shortcuts and extra features.</p>
<h3 id="need-multiple-uids-or-gids"><a class="header" href="#need-multiple-uids-or-gids">Need multiple <code>uid</code>s or <code>gid</code>s</a></h3>
<p>Since we use polkit rules to allow the equivalent of <code>machinectl shell</code> without <code>CAP_ADMIN</code>, and because those rules can only enforce based on <code>uid</code> or <code>gid</code><sup class="footnote-reference"><a href="#only-uid-or-gid">1</a></sup>, we want to isolate that capability in even the simplest design, as it's the highest risk.</p>
<p>Difficult choices ahead: start as root and fork+setuid, or expose multiple services to the admin and risk version skew.
Leaning toward multiple services and detect skew.</p>
<div class="footnote-definition" id="only-uid-or-gid"><sup class="footnote-definition-label">1</sup>
<p>See <a href="https://www.freedesktop.org/software/polkit/docs/latest/polkit.8.html">polkit(8)</a>.
<code>pid</code> is ridiculously hard to use in static files.
<code>groups</code> and <code>user</code> are about as good for us.
<code>seat</code>, <code>session</code>, <code>local</code> and <code>active</code> seem to be about interactive users, not about system services.</p>
</div>
<h3 id="systemd-template-services-instead-of-fork-or-forkexec"><a class="header" href="#systemd-template-services-instead-of-fork-or-forkexec">systemd template services instead of fork or fork+exec</a></h3>
<p>We could have had parent processes fork/fork+exec worker processes.
That could have made it more sure we're using the same executable image, either not exec'ing or using <code>/proc/self/exe</code> or such (Self-exec can help purge resources like open fds, re-randomize some attack mitigations; or use a &quot;nursery&quot; process that spawns children without leftover state).
We chose not to, because either all the child processes would run as the same <code>uid</code>, or we'd need <code>CAP_ADMIN</code> to switch groups.</p>
<p>Instead, systemd <a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#DynamicUser="><code>DynamicUser=yes</code></a> combined with <a href="https://www.freedesktop.org/software/systemd/man/systemd.socket.html#Accept="><code>Accept=yes</code></a> start each process as a separate <code>uid</code>, with unrelated sandboxes.
This works as long as we don't need to pass state from a parent process (or alternatively, we now have to do that via FD socket passing etc).</p>
<p>Downsides: admin has to see internals, might run into version skew, need to connect over UNIX domain sockets instead of just socketpair &amp; fork.</p>
<h2 id="soft"><a class="header" href="#soft">Soft</a></h2>
<h3 id="async-or-threaded-sandbox-granularity"><a class="header" href="#async-or-threaded-sandbox-granularity">async or threaded, sandbox granularity</a></h3>
<p>Do we isolate data in/out of each session into their own processes, or do it all in one?</p>
<p>One per user would sound nice, but it's hard to do because we want to support sharing shell sessions.</p>
<p>Especially if and when we start <a href="../roadmap.html#keep-terminal-state">running terminal emulators on the server</a> lots of small sandboxes sounds like a good idea.</p>
<p>Threaded means we can seccomp &amp; landlock individual threads.
It also makes the system more manageable to ops, e.g. allowing meaningful <code>strace</code> use.
Leaning that way.</p>
<p>Only the non-templated services (without the <code>@</code> suffix) should be handling a large number of connections or tasks <em>within one sandbox</em>, so those are the ones that would benefit from async.
We'll likely sandbox threadpools running async code, there.</p>
<p>Working &amp; secure is better than optimally fast, and it's probably plenty fast anyway.
The cost of the actual shell session should be much higher than our overhead.</p>
<h3 id="authentication-is-tied-to-websocket-connection"><a class="header" href="#authentication-is-tied-to-websocket-connection">Authentication is tied to WebSocket connection</a></h3>
<p>Lose a TCP connection (except in HTTP/3 world), or change IP addresses, and you need to reauthenticate.
Simplifies things greatly, avoids yet another session token that can be stolen, but might not work out well in practise.</p>
<h2 id="undecided"><a class="header" href="#undecided">Undecided</a></h2>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../compare/mosh.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../dev/background/dbus.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../compare/mosh.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../dev/background/dbus.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../doc/mermaid.min.js"></script>
        
        <script type="text/javascript" src="../doc/mermaid-init.js"></script>
        

        

    </body>
</html>
