<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Protocols used in IPC - Tere Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../doc/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../architecture/index.html"><strong aria-hidden="true">2.</strong> Architecture</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../architecture/dbus.html"><strong aria-hidden="true">2.1.</strong> D-Bus</a></li></ol></li><li class="chapter-item expanded "><a href="../../roadmap.html"><strong aria-hidden="true">3.</strong> Roadmap</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Comparisons</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../compare/openssh.html"><strong aria-hidden="true">4.1.</strong> OpenSSH</a></li><li class="chapter-item "><a href="../../compare/mosh.html"><strong aria-hidden="true">4.2.</strong> Mosh</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> For developers</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/decisions.html"><strong aria-hidden="true">5.1.</strong> Decisions</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.2.</strong> Background</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/background/dbus.html"><strong aria-hidden="true">5.2.1.</strong> D-Bus</a></li><li class="chapter-item "><a href="../../dev/background/websockets.html"><strong aria-hidden="true">5.2.2.</strong> WebSockets</a></li><li class="chapter-item "><a href="../../dev/background/pty-stdin-stdout.html"><strong aria-hidden="true">5.2.3.</strong> PTY to stdin/stdout plumbing</a></li></ol></li><li class="chapter-item expanded "><a href="../../dev/sketch/index.html"><strong aria-hidden="true">5.3.</strong> Sketches</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dev/sketch/privsep.html"><strong aria-hidden="true">5.3.1.</strong> Privilege separation</a></li><li class="chapter-item expanded "><a href="../../dev/sketch/protocols.html" class="active"><strong aria-hidden="true">5.3.2.</strong> Protocols used in IPC</a></li><li class="chapter-item "><a href="../../dev/sketch/ipc.html"><strong aria-hidden="true">5.3.3.</strong> IPC</a></li><li class="chapter-item "><a href="../../dev/sketch/attacks.html"><strong aria-hidden="true">5.3.4.</strong> Attacks</a></li><li class="chapter-item "><a href="../../dev/sketch/bastion.html"><strong aria-hidden="true">5.3.5.</strong> Bastion hosts considered harmful</a></li><li class="chapter-item "><a href="../../dev/sketch/unattended-authentication.html"><strong aria-hidden="true">5.3.6.</strong> Unattended authentication</a></li><li class="chapter-item "><a href="../../dev/sketch/account-store.html"><strong aria-hidden="true">5.3.7.</strong> Account store</a></li></ol></li><li class="chapter-item "><a href="../../dev/TODO.html"><strong aria-hidden="true">5.4.</strong> Tasks</a></li><li class="chapter-item "><a href="../../dev/resources.html"><strong aria-hidden="true">5.5.</strong> Resources</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Tere Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="protocols-used-in-ipc"><a class="header" href="#protocols-used-in-ipc">Protocols used in IPC</a></h1>
<p>TODO Extract diagrams from source code.
Getting payload descriptions right could be tricky.</p>
<h2 id="common-handshake"><a class="header" href="#common-handshake">Common handshake</a></h2>
<p>We want to avoid attackers being able to confuse a process about its recipient, and having one protocol message be parsed according to a wholly different protocol.</p>
<p>To make this very explicit, all protocol chats begin with a handshake that identifies the protocol being spoken and the executable file hash.</p>
<p>Since this is an IPC protocol where we don't support mismatching versions, to notice any version skew between services, the handshake includes the executable file hash.</p>
<pre class="mermaid">sequenceDiagram
    client -&gt;&gt; server: intent_client, build_id_client
    server -&gt;&gt; client: intent_server, build_id_server
</pre>
<p>Intents use the context string style of <a href="https://github.com/BLAKE3-team/BLAKE3">BLAKE3</a> <code>derive_key</code>, for example <code>tere 2021-06-03T10:19:27 user to policy client</code>, and correspondingly <code>tere 2021-06-03T10:19:27 user to policy server</code> terminated by a newline.</p>
<p>(TODO if we buy a nice domain, put that in as application instead of just <code>tere</code>?)</p>
<p>Build IDs are BLAKE3 hashes of the executable (via <code>/proc</code> to ensure it matches what's running), keyed by the corresponding intent.
The peer verifies the hash.
We use keyed hashes so you can't just reply by echoing what the client sent.
We don't use any kind of a challenge mechanism, to allow for precomputing the hash.</p>
<h2 id="tere-user-to-tere-policy"><a class="header" href="#tere-user-to-tere-policy"><code>tere-user@</code> to <code>tere-policy@</code></a></h2>
<p>TODO this is an incorrect draft and even at that probably outdated, update from <a href="privsep.html">privsep.md</a></p>
<p><code>tere-user@</code> worker in state <code>Active</code> holds an FD-as-capability that's bound to the currently authenticated user.
On the other end of that FD is a <code>tere-policy@</code> worker.</p>
<pre class="mermaid">sequenceDiagram
    user -&gt;&gt; policy: WebAuthnRegisterInitiate{user_name, display_name}
    policy -&gt;&gt; user: WebAuthnRegisterOptions{publicKeyCredentialCreationOptions}
    user -&gt;&gt; policy: WebAuthnRegisterCredential{credential}
    alt ok
        policy -&gt;&gt; user: Ok
    else failure
        policy -&gt;&gt; user: Error
    end
</pre>
<pre class="mermaid">sequenceDiagram
    participant user
    participant policy
    policy -&gt;&gt; user: AuthenticationRequired{publicKeyCredentialRequestOptions}
    user -&gt;&gt; policy: WebAuthnRegisterCredential{credential}
    alt ok
        policy -&gt;&gt; user: Ok
    else failure
        policy -&gt;&gt; user: Error
    end
</pre>
<h2 id="big-picture"><a class="header" href="#big-picture">Big picture</a></h2>
<pre class="mermaid">sequenceDiagram
    alt allow
        user -&gt;&gt;+ policy: CreateShellSessionRequest{machine,user,args,env}
        note over policy: policy decision: allow
        policy -&gt;&gt;+ sessions: CreateShellSessionRequest{machine,user,args,env}
        sessions -&gt;&gt;- policy: Created{pty_fds}
        # TODO should create auto-open (subscribe) to session? probably yes.
        policy -&gt;&gt; user: Created
    else deny
        user -&gt;&gt;+ policy: CreateShellSession
        note over policy: policy decision: deny
        policy -&gt;&gt;- user: Denied
    else failure
        user -&gt;&gt;+ policy: CreateShellSession
        note over policy: policy decision: allow
        policy -&gt;&gt;+ sessions: CreateShellSessionRequest{machine,user,args,env}
        sessions -&gt;&gt;- policy: Failed
        policy -&gt;&gt;- user: Failed
    end
</pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../dev/sketch/privsep.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../dev/sketch/ipc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../dev/sketch/privsep.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../dev/sketch/ipc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../doc/mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../doc/mermaid-init.js"></script>
        

        

    </body>
</html>
